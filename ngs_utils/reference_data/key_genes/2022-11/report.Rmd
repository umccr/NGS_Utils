---
title: "Cancer gene panel generation"
output: html_document
---

```{r}
{
  library(glue, include.only = "glue")
  library(here, include.only = "here")
  library(readr, include.only = c("read_tsv", "read_csv", "cols"))
  library(tidyr, include.only = c("pivot_longer"))
  library(tibble, include.only = c("tibble"))
  library(purrr, include.only = c("map"))
  library(dplyr, include.only = c("select", "filter", "mutate", "arrange", "left_join", "count"))
}
```

## New

| Source | Link | DateAccessed | Notes |
|--------|------|--------|------|
| CPSR | [CPSR-web](https://sigven.github.io/cpsr/cpsr_superpanel_2022_01.xlsx) | 2023-08 | Excel sheet with 433 genes, downloaded directly from website. |
| Cancermine | [Cancermine-Zenodo](https://zenodo.org/record/7689627) | 2023-08 | Downloaded `cancermine_collated.tsv` from Zenodo link, 35,315 rows, md5: 03a... |
| COSMIC | [COSMIC-download](https://cancer.sanger.ac.uk/cosmic/download) | 2023-08 | Download by logging in, selecting from the side panel `Projects`/`COSMIC`/`Cancer Gene Census`/`Cosmic_CancerGeneCensus_Tsv_v98_GRCh38.tar`. TSV has 738 genes. |
| NCG | [NCG-download](http://network-cancer-genes.org/download.php) | 2023-08 | Download `Annotation and supporting evidence/3347 cancer drivers`. TSV has 8887 rows. |
| OncoKB | [OncoKB-download](https://www.oncokb.org/cancerGenes) | 2023-08 | Download `Cancer Gene List`, TSV has 1,107 genes. |
| Tempus | [Tempus-xT-](https://www.tempus.com/oncology/genomic-profiling/xt-xr/) | 2023-08 | Download `xT Gene List` PDF, copy gene columns, total 648 genes. |

```{r read_sources}
wd <- here("ngs_utils/reference_data/key_genes/2022-11")
# src_xl <- file.path(wd, "sources/Updated Gene List Sources and Details.xlsx") |>
#   readxl::read_xlsx()
cpsr <- file.path(wd, "sources/cpsr_superpanel_2022_01.xlsx") |>
  readxl::read_xlsx() |>
  dplyr::select(symbol, ensembl_gene_id, entrezgene)
cancermine <- file.path(wd, "sources/cancermine_collated.tsv") |>
  readr::read_tsv(col_types = cols(.default = "c", citation_count = "i"))
cosmic <- file.path(wd, "sources/Cosmic_CancerGeneCensus_v98_GRCh38.tsv") |>
  readr::read_tsv(col_types = cols(.default = "c", GENOME_START = "i", GENOME_STOP = "i"))
ncg <- file.path(wd, "sources/NCG_cancerdrivers_annotation_supporting_evidence.tsv") |>
  readr::read_tsv(col_types = cols(.default = "c"))
oncokb <- file.path(wd, "sources/oncokb_cancerGeneList_202308.tsv") |>
  readr::read_tsv(col_types = cols(.default = "c"))
tempus <- file.path(wd, "sources/tempus_2023-08.txt") |>
  readr::read_tsv(col_types = "c")
```

```{r cancermine_prep}
citation_count_min <- 3
cancermine_prep <-
  cancermine |>
  dplyr::mutate(symbol = gene_normalized,
         cm_cite = citation_count,
         cm_og = role == "Oncogene",
         cm_ts = role == "Tumor_Suppressor",
         cm_driver = role == "Driver") |>
  # dplyr::filter(citation_count >= citation_count_min | symbol == "SMURF1") |>
  dplyr::select(symbol, starts_with("cm_")) |>
  dplyr::group_by(symbol) |>
  dplyr::summarise(
    # sources = "cancermine",
    cm_pub = dplyr::n()
  ) |>
  dplyr::ungroup() |>
  dplyr::arrange(dplyr::desc(cm_pub))
    cm_total_cite = sum(cm_cite),
    cm_og = mean(cm_og),
    cm_ts = mean(cm_ts),
    cm_driver = mean(cm_driver)) |>
  dplyr::filter(cm_pub >= 2)
```

```{r df_with_src}
d <- list(
  cancermine = cancermine |> dplyr::select(symbol = "gene_normalized") |> dplyr::distinct() |> dplyr::arrange(),
  cosmic = cosmic |> dplyr::select(symbol = "GENE_SYMBOL") |> dplyr::distinct() |> arrange(),
  ncg = ncg |> dplyr::select("symbol") |> dplyr::distinct() |> dplyr::arrange(),
  oncokb = oncokb |> dplyr::select(symbol = "Hugo Symbol") |> dplyr::distinct() |> dplyr::arrange(),
  tempus = tempus |> dplyr::distinct() |> dplyr::arrange()
) |>
  dplyr::bind_rows(.id = "source") |>
  dplyr::group_by(symbol) |>
  dplyr::mutate(
    n = dplyr::n(),
    sources = stringr::str_c(source, collapse = "|"),
  )
```

## Old

```{r diffs}
wd2 <- here("ngs_utils/reference_data/key_genes")
cancermine2 <- file.path(wd2, "sources/cancermine_collated.tsv") |>
  readr::read_tsv(col_types = cols(.default = "c", citation_count = "i"))
cosmic2 <- dplyr::bind_rows(
  file.path(wd2, "sources/CancerGeneCensus_Tier1.tsv") |> readr::read_tsv(),
  file.path(wd2, "sources/CancerGeneCensus_Tier2.tsv") |> readr::read_tsv())
ncg2 <- file.path(wd2, "sources/NCG_cancerdrivers_annotation_supporting_evidence.tsv") |>
  readr::read_tsv(col_types = readr::cols(.default = "c"))
oncokb2 <- file.path(wd, "sources/cancerGeneList_202308.tsv") |>
  readr::read_tsv(col_types = readr::cols(.default = "c"))
tempus2 <- file.path(wd2, "sources/tempus.txt") |>
  readr::read_tsv(col_types = "c", col_names = "symbol") |>
  dplyr::mutate(
    symbol = sub("\\*+", "", symbol), # remove stars
    symbol = sub("\\(", "", symbol), # remove parentheses
    symbol = sub("\\)", "", symbol)
  )

# oncokb differences
# 2022-10-28, 1,068 genes
#oncokb_old <- file.path(wd, "../sources/oncoKB_cancerGeneList.txt") |>
#  read_tsv(col_types = cols(.default = "c"))
#table(oncokb$`Hugo Symbol` %in% oncokb_old$`Hugo Symbol`)
#table(oncokb_old$`Hugo Symbol` %in% oncokb$`Hugo Symbol`)
#oncokb[!oncokb$`Hugo Symbol` %in% oncokb_old$`Hugo Symbol`, ] |> arrange(`Hugo Symbol`)
#oncokb_old[!oncokb_old$`Hugo Symbol` %in% oncokb$`Hugo Symbol`, ] |> arrange(`Hugo Symbol`)
#
## TEMPUS differences
#tempus_old <- file.path(wd, "../sources/TEMPUS.genes") |>
#  read_tsv(col_types = "c", col_names = "symbol")
#
#table(tempus$symbol %in% tempus_old$symbol)
#table(tempus_old$symbol %in% tempus$symbol)
#
## old ones not in new
#tempus_old[!tempus_old$symbol %in% tempus$symbol, ]
## new ones not in old
#tempus[!tempus$symbol %in% tempus_old$symbol, ]
```

## CPSR custom panel

```{r cpsr_custom_panel_prep}
##---- CPSR ----##
predispose_genes <- file.path(wd, "../sources/predispose_genes.txt") |>
  readr::read_tsv(col_names = "symbol", col_types = "c")
predispose_genes$symbol %in% cpsr$symbol |>
  table(useNA = "a")
predispose_genes |>
  dplyr::filter(!symbol %in% cpsr$symbol)
predispose_genes |>
  dplyr::left_join(cpsr) |>
  dplyr::filter(!is.na(ensembl_gene_id)) |>
  dplyr::select("ensembl_gene_id") |>
  readr::write_tsv(file.path(wd, "output", "cpsr_predisposition_genes_ensembl.txt"), col_names = FALSE)
```

